<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="菜鸟程序猿" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="李超的技术博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="李超的技术博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="李超的技术博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '6363154125210667000',
      author: 'bill666500'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> 李超的技术博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">李超的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">既然改变不了全世界，就努力改变自己</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/13/React-Native解决iOS项目编译问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/13/React-Native解决iOS项目编译问题/" itemprop="url">
                  React-Native解决iOS项目编译问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-13T11:31:18+08:00">
                2017-09-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS深入浅出/" itemprop="url" rel="index">
                    <span itemprop="name">iOS深入浅出</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1>React-Native解决iOS项目编译问题</h1>

<p>在平时做项目中，我们很可能通过pod方式引入React Native，看网上资料大多数还是解决不了0.46以上的问题，目前个人用的是0.47.1版本，大多数网上资料针对最新版已经不适用了，大多数类似在podfile文件添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">pod &apos;React&apos;, :path =&gt; &apos;./Test/node_modules/react-native&apos;, :subspecs =&gt; [</div><div class="line">  &apos;Core&apos;,</div><div class="line">  &apos;RCTText&apos;,</div><div class="line">  &apos;RCTImage&apos;,</div><div class="line">  &apos;RCTActionSheet&apos;,</div><div class="line">  &apos;RCTGeolocation&apos;,</div><div class="line">  &apos;RCTNetwork&apos;,</div><div class="line">  &apos;RCTSettings&apos;,</div><div class="line">  &apos;RCTVibration&apos;,</div><div class="line">  &apos;RCTWebSocket&apos;,</div><div class="line">  ]</div></pre></td></tr></table></figure>
<p>可是始终编译不通过，<br><img src="/2017/09/13/React-Native解决iOS项目编译问题/1.JPG" alt="image"></p>
<p>纳尼，难道我自己安装的环境不行，结果不得不去谷歌一下，但是第一个我搜了没有相应想要的信息，好吧，我从最后面那条信息入手<code>_JSNoBytecodeFileFormatVersion,referenced from:</code>很快就找到答案</p>
<p><img src="/2017/09/13/React-Native解决iOS项目编译问题/2.png" alt="image"></p>
<p><a href="https://github.com/facebook/react-native/issues/14749" target="_blank" rel="external">在此链接</a>我们找到了想要的答案</p>
<p><img src="/2017/09/13/React-Native解决iOS项目编译问题/3.png" alt="image"></p>
<p>最终要在podfile文件添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">pod &apos;React&apos;, :path =&gt; &apos;./Test/node_modules/react-native&apos;, :subspecs =&gt; [</div><div class="line">  &apos;Core&apos;,</div><div class="line">  &apos;RCTText&apos;,</div><div class="line">  &apos;RCTImage&apos;,</div><div class="line">  &apos;RCTActionSheet&apos;,</div><div class="line">  &apos;RCTGeolocation&apos;,</div><div class="line">  &apos;RCTNetwork&apos;,</div><div class="line">  &apos;RCTSettings&apos;,</div><div class="line">  &apos;RCTVibration&apos;,</div><div class="line">  &apos;RCTWebSocket&apos;,</div><div class="line">  &apos;BatchedBridge&apos;</div><div class="line">  ]</div></pre></td></tr></table></figure>
<p>这样就可以完美解决0.46以上版本编译不通过的问题。下回有时间介绍下在项目中针对RN遇到的一些麻烦问题。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/06/React-Native-之新手入门进阶一/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/06/React-Native-之新手入门进阶一/" itemprop="url">
                  React Native 之新手入门进阶一
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-06T19:59:32+08:00">
                2017-09-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS深入浅出/" itemprop="url" rel="index">
                    <span itemprop="name">iOS深入浅出</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1>React Native 之新手入门进阶一</h1>

<h3>1.1 React Native 简单介绍</h3>

<p><img src="/2017/09/06/React-Native-之新手入门进阶一/1.png" alt="image"></p>
<p>React Native 诞生于 2015 年，名副其实的富二代，主要使命是为父出征，与 Apple 和 Google 抗衡，为开发者带去一套跨平台、动态更新的 Javascript 框架，口号是：Learn once, write anywhere：Build mobile apps with React。在试图推翻 Android 和 iOS 压制的同时，还提携了一把自家兄弟：React。 <br></p>
<h3>1.2 React Native的优势</h3>

<li>跨平台＋动态更新</li>

<p>传统的客户端开发模式是怎样的呢？</p>
<p>Android 与 iOS Team 分别编写客户端代码，打包，分发到 Play Store 和 Apple Store，通过更新 JSON 数据来更新页面。</p>
<p>不过，当客户端发生严重问题而服务器上无法 quick fix 时，就不得不重新发版。</p>
<p>对国外 Android 市场而言还好，因为能通过 Play Store 快速更新；国内 Android 市场则由于分发渠道太杂，很难及时把新版本立即推送给所有用户，当然这也是为何热修复技术在国内盛行而国外冷清的原因；而 Apple Store 则需要一定的审核时间，而且最近又在抓 iOS 热修复框架如 JsPatch、Rollout 等。</p>
<p>相比而言，Hybrid 和 RN/Weex 模式除了能下发 Json 数据来刷新界面内容，更能直接下发业务逻辑代码，直接实现整体 App 的更新。而且，它们不用在乎 Android 和 iOS 两个平台，因为一份 JS 代码写好后，把 JS Bundle 放在服务器上，所有的客户端立即更新。</p>
<li>代码复用</li><br>一般而言，同一款产品的 Android 和 iOS 两端除 UI 有些许不同外，多数业务逻辑几乎完全一致，这便造成了人力的浪费。<br><br>而最近 Instagram 的官博 React Native at Instagram 一文中已经提到，利用 RN (React Native 缩写，下同) 开发的 feature 可以实现 85% - 99% 的代码复用率。这意味着我们可以用更少的人力成本来达到相同的效果。<br><br><h3>1.3 React Native的劣势</h3><br><br><li>学习成本。Weex 的写法就是类似常规的 Html/JS，对于前端人员来说很容易上手，就算了非前端人员来说也花不了多久。而 RN 是在 React.js 上进行改进形成的一套语法，和常规前端差别较大，因此需要好几天的学习适应。当然我觉得优秀的程序员的基本素质之一就是能快速学习、练习并熟练一种新语言的。我个人的话大概花了两三天的时间已经能完成一套涵盖网络、JS与Native通信的页面了，对于 React.js 语法也上手很快。</li> 

<li>安装包 Size。对于 iOS 而言影响不算很大，对于 Android 来说,查看了下资料需要用 split apk 的技术就能缩小到到 1MB 左右的增幅。</li>

<li>首次加载耗时。大家知道 RN 需要从服务器下载 JS bundle，然后在本地转化成 Native code 运行的，所以在第一次打开 App 时需要花费一些时间进行下载和刷新。当然我们可以在发布 client 时内置一个写好的 js 文件在本地作缓存用。</li>

<h3>2 React Native 运行机制</h3>

<p>对于一个用 RN 搭建的移动 App，在启动后会从服务器下载最新的 JS Bundle 文件，然后由本地 JavascriptCore 引擎对 JS 文件进行解析，并利用 Bridge 映射到对应的 Native 方法和 UI 控件。得到的效果是：</p>
<li>同样的 RN 代码，下发到 Android 和 iOS 不同平台中，会自动调用对应 Native 的 UI 控件，保证了各平台用户体验的连贯性</li>

<li>开发者就算是移动端小白，只要有 Web 基础，通过编写一套 RN 端代码就可以同时完成 Android 与 iOS App 的开发</li>

<li>由于可以利用 JS bundle 同时下发数据和业务逻辑，这意味着你可以像 Web 开发一样，实时迭代更新你的移动端 App，无需在了解各自平台的热修复技术</li>

<li>Native Modules，这是 RN 强大的一个扩展性，允许你通过简单的代码就能实现在 JS 里直接调用你自己的 Native 方法</li>

<li>Native Components，如果你自己实现了一些复杂的 Native UI 组件，而这些组件尚未被 RN 支持，你可以利用 Native Components 快速把原生组件引入到 RN 中并可以直接在 JS 里更新这些组件的状态</li>


<h3>3 React Native 开发环境搭建</h3>

<p>###使用React Native开发iOS应用需要OSX系统，Xcode，Homebrew，node，npm</p>
<p>###3.1 安装Homebrew</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Homebrew, 简称brew, Mac系统的包管理器, 用于安装NodeJS和一些其他必需的工具软件。</div><div class="line">Home-brew 的使用方式:</div><div class="line">1)搜索软件：brew search 软件名，如brew search wget</div><div class="line">2)安装软件：brew install 软件名，如brew install wget</div><div class="line">3)卸载软件：brew remove 软件名，如brew remove wget</div></pre></td></tr></table></figure>
<p>打开终端，运行以下语句（中间需要输入密码）进行安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</div></pre></td></tr></table></figure>
<p>可通过如下语句查看安装是否成功以及安装的Homebrew版本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew -v</div></pre></td></tr></table></figure>
<p>正常情况下均可安装成功，若出现网络问题安装失败，则运行如下语句清理后再重新安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/uninstall)&quot;</div><div class="line">ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</div></pre></td></tr></table></figure>
<p>###3.2 使用Homebrew来安装Node.js</p>
<p>终端运行语句如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install node</div></pre></td></tr></table></figure>
<p>安装完node后建议设置npm镜像以加速后面的过程（或使用科学上网工具）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm config set registry https://registry.npm.taobao.org --global</div><div class="line">npm config set disturl https://npm.taobao.org/dist --global</div></pre></td></tr></table></figure>
<p>###3.3 Yarn、React Native的命令行工具（react-native-cli）</p>
<p>Yarn是Facebook提供的替代npm的工具，可以加速node模块的下载。React Native的命令行工具用于执行创建、初始化、更新项目、运行打包服务（packager）等任务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install -g yarn react-native-cli</div></pre></td></tr></table></figure>
<p>安装完yarn后同理也要设置镜像源：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yarn config set registry https://registry.npm.taobao.org --global</div><div class="line">yarn config set disturl https://npm.taobao.org/dist --global</div></pre></td></tr></table></figure>
<p>如果你看到<code>EACCES: permission denied</code>这样的权限报错，那么请参照上文的<code>homebrew</code>译注，修复<code>/usr/local</code>目录的所有权：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chown -R `whoami` /usr/local</div></pre></td></tr></table></figure>
<p>###3.4 React Native开发之IDE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1.WebStorm</div><div class="line">2.Sublime Text</div><div class="line">3.Atom</div></pre></td></tr></table></figure>
<h3>4 创建一个RN项目</h3>

<p>###4.1 初始化创建项目</p>
<p>切换到指定目录文件路径之后，命令行创建项目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">react-native init RNDemo</div></pre></td></tr></table></figure>
<p>###4.2 初始化创建项目<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//  视情况而定，总之进入项目根目录</div><div class="line">cd RNDemo</div><div class="line"></div><div class="line">//  运行iOS项目</div><div class="line">react-native run-ios</div></pre></td></tr></table></figure></p>
<p>###4.3 iOS原生运行方法</p>
<p>双击ios/AwesomeProject.xcodeproj文件然后在Xcode中点击Run按钮。（最常用，对iOS开发者）</p>
<p>###4.4 简单的修改调试</p>
<p>使用你喜欢的编辑器打开index.ios.js并随便改上几行。<br>在iOS Emulator中按下⌘-R就可以刷新APP并看到你的最新修改！</p>
<p><strong>最后总结：这只是入门的第一篇，接下来有时间会陆续更新项目遇到的问题</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/27/Block的使用注意事项/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/27/Block的使用注意事项/" itemprop="url">
                  Block的使用注意事项
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-27T14:45:30+08:00">
                2017-07-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS基础/" itemprop="url" rel="index">
                    <span itemprop="name">iOS基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1>Block的使用注意事项</h1>

<h3>防止循环引用</h3>

<p>众所周知，Block 在使用的时候默认会使对象的引用计数加一，所以我们需要使用 __weak 关键字来防止对象（主要是指拥有此 Block 所在对象的控制器）和 Block 循环引用。如下代码所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">MyViewController *myController = [[MyViewController alloc] init…];</div><div class="line"> // ...</div><div class="line">MyViewController * __weak weakMyViewController = myController;</div><div class="line">myController.completionHandler = ^(NSInteger result) &#123;</div><div class="line">    [weakMyViewController dismissViewControllerAnimated:YES completion:nil];</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>但是这样就可以了吗？假如是多线程的情况下，weakMyViewController已经释放了，那么就会发生闪退现象，不信我们可以做个试验，talk is cheap, show me the code.</p>
<p>我们做个试验，有两个ViewController,两个ViewController都有按钮触发事件，关键代码如下：<br>ViewController.m文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">#import &quot;ViewController.h&quot;</div><div class="line">#import &quot;CustomController.h&quot;</div><div class="line"></div><div class="line">@interface ViewController ()</div><div class="line"></div><div class="line">- (IBAction)clickAction:(id)sender;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    // Do any additional setup after loading the view, typically from a nib.</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)didReceiveMemoryWarning &#123;</div><div class="line">    [super didReceiveMemoryWarning];</div><div class="line">    // Dispose of any resources that can be recreated.</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (IBAction)clickAction:(id)sender &#123;</div><div class="line">    CustomController *custom = [[CustomController alloc] init];</div><div class="line">    [self presentViewController:custom animated:YES completion:nil];</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>CustomController.m文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">#import &quot;CustomController.h&quot;</div><div class="line"></div><div class="line">typedef void(^CustomBlock)();</div><div class="line">typedef void(^LogBlock)();</div><div class="line"></div><div class="line">@interface CustomController ()</div><div class="line"></div><div class="line">@property (nonatomic, copy) CustomBlock block;</div><div class="line">@property (nonatomic, copy) LogBlock   logBlock;</div><div class="line"></div><div class="line">- (IBAction)clickAction:(id)sender;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation CustomController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line">    // Do any additional setup after loading the view.</div><div class="line">    </div><div class="line">    self.view.backgroundColor = [UIColor whiteColor];</div><div class="line">    __weak typeof(self) weakSelf = self;</div><div class="line">    </div><div class="line">    self.logBlock = ^&#123;</div><div class="line">        NSLog(@&quot;%@&quot;,weakSelf);</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    self.block = ^&#123;</div><div class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">            weakSelf.logBlock();</div><div class="line">        &#125;);</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (IBAction)clickAction:(id)sender &#123;</div><div class="line">    self.block();</div><div class="line">    [self dismissViewControllerAnimated:YES completion:nil];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)didReceiveMemoryWarning &#123;</div><div class="line">    [super didReceiveMemoryWarning];</div><div class="line">    // Dispose of any resources that can be recreated.</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>运行结果<br><img src="/2017/07/27/Block的使用注意事项/weak-strong dance1.png" alt="image"><br>不难发现我们直接闪退，纳尼，一看<code>weakSelf</code>是nil!!! 那我们怎么办呢？这是为后面做的铺垫，请看下面。<br></p>
<h3>Weak-Strong Dance</h3>

<p><strong>什么是 Weak-Strong Dance ？</strong></p>
<p><strong>在使用的 Block 时， 除了使用 <strong>weak 修饰符去避免循环引用外，还可以通过名为 Weak-Strong Dance 的方式去避免循环引用。 其实 Weak-Strong Dance 并不是一个新东西，它只是 </strong>weak 的一个升级版本。主要目的是为了避免在极端情况下 __weak 这种情况会出现的问题。</strong></p>
<p>按照上面的代码我们做些修改，只改<code>ViewDidLoad</code>中的<code>self.block</code>里面的即可。代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">self.block = ^&#123;</div><div class="line">     __strong typeof(self) strongSelf = weakSelf;</div><div class="line">      dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">           strongSelf.logBlock();</div><div class="line">      &#125;);</div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<p>这样我们就可以正常运行了，没有闪退。<code>strong typeof(weakSelf)strongSelf = weakSelf;</code>就是解决这个问题的关键~先将强引用的对象转为弱引用指针，防止了 Block 和对象之间的循环引用。再在 Block 的第一句代码出将 <code>weakSelf</code> 的弱引用转换成 <code>strongSelf</code> 这样的强引用指针，防止了<code>多线程</code>和 <code>ARC</code> 环境下弱引用随时被释放的问题（因为强引用的引用计数至少为1）。 </p>
<p>这样就可以安心使用了吗？NO!!! 请看下文。</p>
<h3>Weak-Strong Dance真的安全吗？</h3>

<p>会有什么问题吗？有，假如在执行<code>__strong typeof(self) strongSelf = weakSelf;</code>这句之前<code>weakSelf</code>已经释放了？怎么办？我们还是按照上文的例子继续改造，这样运行结果能说明问题。代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">self.block = ^&#123;</div><div class="line">     dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">         __strong typeof(self) strongSelf = weakSelf;</div><div class="line">         dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">             strongSelf.logBlock();</div><div class="line">         &#125;);</div><div class="line">     &#125;);</div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<p>我们执行下，结果如下：<br><img src="/2017/07/27/Block的使用注意事项/weak-strong dance2.png" alt="image"><br>纳尼？逗我玩儿? <code>strongSelf</code> 居然为nil，是滴，这就是我们要说的上述可能会存在的问题。所以需要继续改造才可以，代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">self.block = ^&#123;</div><div class="line">        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">         __strong typeof(self) strongSelf = weakSelf;</div><div class="line">         dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">             if(strongSelf) &#123;</div><div class="line">                 strongSelf.logBlock();</div><div class="line">             &#125; else &#123;</div><div class="line">                 NSLog(@&quot;strongSelf = nil!!!&quot;);</div><div class="line">             &#125;</div><div class="line">         &#125;);</div><div class="line">     &#125;);</div><div class="line"> &#125;;</div></pre></td></tr></table></figure>
<p>这样就可以解决闪退问题，因为可能<code>strongSelf</code>为nil, 所以需要判断即可。这样才算真正的解决Block的问题。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/14/App卡顿监测/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/14/App卡顿监测/" itemprop="url">
                  App卡顿监测
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-14T13:16:00+08:00">
                2017-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS基础/" itemprop="url" rel="index">
                    <span itemprop="name">iOS基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>由于最近需求多忙于工作，最近很少更新博客了，希望这段时间能够多花时间谢谢博客，补充技术技能。<br>今天要介绍的RunLoop使用场景很有意思，在做长期项目，需要跟踪解决用户问题非常有用。<br>使用RunLoop 监测主线程的卡顿，并将卡顿时的线程堆栈信息保存下来，下次上传到服务器。</p>
<h3>参考资料</h3>

<p>关于今天要介绍的使用RunLoop 监测主线程卡顿的资料如下：</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=207890859&idx=1&sn=e98dd604cdb854e7a5808d2072c29162" target="_blank" rel="external">微信iOS卡顿监控系统</a>（这篇文章要首先阅读，了解有哪些情况会引起主线程卡顿，监测到卡顿后怎么处理等）<br><br><a href="http://www.jianshu.com/p/71cfbcb15842" target="_blank" rel="external">简单监测iOS卡顿的demo </a> （使用RunLoop监测卡顿的例子）</p>
<h3>原理</h3>

<p>官方文档说明了RunLoop的执行顺序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">1. Notify observers that the run loop has been entered.</div><div class="line">2. Notify observers that any ready timers are about to fire.</div><div class="line">3. Notify observers that any input sources that are not port based are about to fire.</div><div class="line">4. Fire any non-port-based input sources that are ready to fire.</div><div class="line">5. If a port-based input source is ready and waiting to fire, process the event immediately. Go to step 9.</div><div class="line">6. Notify observers that the thread is about to sleep.</div><div class="line">7. Put the thread to sleep until one of the following events occurs:</div><div class="line"> * An event arrives for a port-based input source.</div><div class="line"> * A timer fires.</div><div class="line"> * The timeout value set for the run loop expires.</div><div class="line"> * The run loop is explicitly woken up.</div><div class="line">8. Notify observers that the thread just woke up.</div><div class="line">9. Process the pending event.</div><div class="line"> * If a user-defined timer fired, process the timer event and restart the loop. Go to step 2.</div><div class="line"> * If an input source fired, deliver the event.</div><div class="line"> * If the run loop was explicitly woken up but has not yet timed out, restart the loop. Go to step 2.</div><div class="line">10. Notify observers that the run loop has exited.</div></pre></td></tr></table></figure>
<p>用伪代码来实现就是这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">/// 1. 通知Observers，即将进入RunLoop</div><div class="line">    /// 此处有Observer会创建AutoreleasePool: _objc_autoreleasePoolPush();</div><div class="line">    __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopEntry);</div><div class="line">do &#123;</div><div class="line"></div><div class="line">        /// 2. 通知 Observers: 即将触发 Timer 回调。</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeTimers);</div><div class="line">        /// 3. 通知 Observers: 即将触发 Source (非基于port的,Source0) 回调。</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeSources);</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);</div><div class="line"></div><div class="line">        /// 4. 触发 Source0 (非基于port的) 回调。</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__(source0);</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);</div><div class="line"></div><div class="line">        /// 6. 通知Observers，即将进入休眠</div><div class="line">        /// 此处有Observer释放并新建AutoreleasePool: _objc_autoreleasePoolPop(); _objc_autoreleasePoolPush();</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopBeforeWaiting);</div><div class="line"></div><div class="line">        /// 7. sleep to wait msg.</div><div class="line">        mach_msg() -&gt; mach_msg_trap();</div><div class="line"></div><div class="line"></div><div class="line">        /// 8. 通知Observers，线程被唤醒</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopAfterWaiting);</div><div class="line"></div><div class="line">        /// 9. 如果是被Timer唤醒的，回调Timer</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__(timer);</div><div class="line"></div><div class="line">        /// 9. 如果是被dispatch唤醒的，执行所有调用 dispatch_async 等方法放入main queue 的 block</div><div class="line">        __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(dispatched_block);</div><div class="line"></div><div class="line">        /// 9. 如果如果Runloop是被 Source1 (基于port的) 的事件唤醒了，处理这个事件</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__(source1);</div><div class="line"></div><div class="line"></div><div class="line">    &#125; while (...);</div><div class="line"></div><div class="line">    /// 10. 通知Observers，即将退出RunLoop</div><div class="line">    /// 此处有Observer释放AutoreleasePool: _objc_autoreleasePoolPop();</div><div class="line">    __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(kCFRunLoopExit);</div></pre></td></tr></table></figure>
<p>主线程的RunLoop是在应用启动时自动开启的，也没有超时时间，所以正常情况下，主线程的RunLoop 只会在 2—9 之间无限循环下去。<br>那么，我们只需要在主线程的RunLoop中添加一个observer，检测从 kCFRunLoopBeforeSources 到 kCFRunLoopBeforeWaiting 花费的时间 是否过长。如果花费的时间大于某一个阙值，我们就认为有卡顿，并把当前的线程堆栈转储到文件中，并在以后某个合适的时间，将卡顿信息文件上传到服务器。</p>
<h3>实现步骤</h3>

<p>在看了上面的两个监测卡顿的示例Demo后，我按照上面讲述的思路写了一个Demo，应该更容易理解吧。<br>第一步，创建一个子线程，在线程启动时，启动其RunLoop。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)shareMonitor</div><div class="line">&#123;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        instance = [[[self class] alloc] init];</div><div class="line">        instance.monitorThread = [[NSThread alloc] initWithTarget:self selector:@selector(monitorThreadEntryPoint) object:nil];</div><div class="line">        [instance.monitorThread start];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return instance;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (void)monitorThreadEntryPoint</div><div class="line">&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        [[NSThread currentThread] setName:@&quot;FluencyMonitor&quot;];</div><div class="line">        NSRunLoop *runLoop = [NSRunLoop currentRunLoop];</div><div class="line">        [runLoop addPort:[NSMachPort port] forMode:NSDefaultRunLoopMode];</div><div class="line">        [runLoop run];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第二步，在开始监测时，往主线程的RunLoop中添加一个observer，并往子线程中添加一个定时器，每0.5秒检测一次耗时的时长。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">- (void)start</div><div class="line">&#123;</div><div class="line">    if (_observer) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 1.创建observer</div><div class="line">    CFRunLoopObserverContext context = &#123;0,(__bridge void*)self, NULL, NULL, NULL&#125;;</div><div class="line">    _observer = CFRunLoopObserverCreate(kCFAllocatorDefault,</div><div class="line">                                              kCFRunLoopAllActivities,</div><div class="line">                                              YES,</div><div class="line">                                              0,</div><div class="line">                                              &amp;runLoopObserverCallBack,</div><div class="line">                                              &amp;context);</div><div class="line">    // 2.将observer添加到主线程的RunLoop中</div><div class="line">    CFRunLoopAddObserver(CFRunLoopGetMain(), _observer, kCFRunLoopCommonModes);</div><div class="line"></div><div class="line">    // 3.创建一个timer，并添加到子线程的RunLoop中</div><div class="line">    [self performSelector:@selector(addTimerToMonitorThread) onThread:self.monitorThread withObject:nil waitUntilDone:NO modes:@[NSRunLoopCommonModes]];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)addTimerToMonitorThread</div><div class="line">&#123;</div><div class="line">    if (_timer) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    // 创建一个timer</div><div class="line">    CFRunLoopRef currentRunLoop = CFRunLoopGetCurrent();</div><div class="line">    CFRunLoopTimerContext context = &#123;0, (__bridge void*)self, NULL, NULL, NULL&#125;;</div><div class="line">    _timer = CFRunLoopTimerCreate(kCFAllocatorDefault, 0.1, 0.01, 0, 0,</div><div class="line">                                                   &amp;runLoopTimerCallBack, &amp;context);</div><div class="line">    // 添加到子线程的RunLoop中</div><div class="line">    CFRunLoopAddTimer(currentRunLoop, _timer, kCFRunLoopCommonModes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第三步，补充观察者回调处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">static void runLoopObserverCallBack(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info)&#123;</div><div class="line">    FluencyMonitor *monitor = (__bridge FluencyMonitor*)info;</div><div class="line">    NSLog(@&quot;MainRunLoop---%@&quot;,[NSThread currentThread]);</div><div class="line">    switch (activity) &#123;</div><div class="line">        case kCFRunLoopEntry:</div><div class="line">            NSLog(@&quot;kCFRunLoopEntry&quot;);</div><div class="line">            break;</div><div class="line">        case kCFRunLoopBeforeTimers:</div><div class="line">            NSLog(@&quot;kCFRunLoopBeforeTimers&quot;);</div><div class="line">            break;</div><div class="line">        case kCFRunLoopBeforeSources:</div><div class="line">            NSLog(@&quot;kCFRunLoopBeforeSources&quot;);</div><div class="line">            monitor.startDate = [NSDate date];</div><div class="line">            monitor.excuting = YES;</div><div class="line">            break;</div><div class="line">        case kCFRunLoopBeforeWaiting:</div><div class="line">            NSLog(@&quot;kCFRunLoopBeforeWaiting&quot;);</div><div class="line">            monitor.excuting = NO;</div><div class="line">            break;</div><div class="line">        case kCFRunLoopAfterWaiting:</div><div class="line">            NSLog(@&quot;kCFRunLoopAfterWaiting&quot;);</div><div class="line">            break;</div><div class="line">        case kCFRunLoopExit:</div><div class="line">            NSLog(@&quot;kCFRunLoopExit&quot;);</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从打印信息来看，RunLoop进入睡眠状态的时间可能会非常短，有时候只有1毫秒，有时候甚至1毫秒都不到，静止不动时，则会长时间进入睡觉状态。</p>
<p>因为主线程中的block、交互事件、以及其他任务都是在kCFRunLoopBeforeSources 到 kCFRunLoopBeforeWaiting 之前执行，所以我在即将开始执行Sources 时，记录一下时间，并把正在执行任务的标记置为YES，将要进入睡眠状态时，将正在执行任务的标记置为NO。</p>
<p>第四步，补充timer 的回调处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">static void runLoopTimerCallBack(CFRunLoopTimerRef timer, void *info)</div><div class="line">&#123;</div><div class="line">    FluencyMonitor *monitor = (__bridge FluencyMonitor*)info;</div><div class="line">    if (!monitor.excuting) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 如果主线程正在执行任务，并且这一次loop 执行到 现在还没执行完，那就需要计算时间差</div><div class="line">    NSTimeInterval excuteTime = [[NSDate date] timeIntervalSinceDate:monitor.startDate];</div><div class="line">    NSLog(@&quot;定时器---%@&quot;,[NSThread currentThread]);</div><div class="line">    NSLog(@&quot;主线程执行了---%f秒&quot;,excuteTime);</div><div class="line"></div><div class="line">    if (excuteTime &gt;= 0.01) &#123;</div><div class="line">        NSLog(@&quot;线程卡顿了%f秒&quot;,excuteTime);</div><div class="line">        [monitor handleStackInfo];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>timer 每 0.01秒执行一次，如果当前正在执行任务的状态为YES，并且从开始执行到现在的时间大于阙值，则把堆栈信息保存下来，便于后面处理。<br>为了能够捕获到堆栈信息，我把timer的间隔调的很小（0.01），而评定为卡顿的阙值也调的很小（0.01）。 实际使用时这两个值应该是比较大，timer间隔为1s，卡顿阙值为2s即可。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/15/属性的本质2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/15/属性的本质2/" itemprop="url">
                  属性的本质2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-15T15:40:01+08:00">
                2017-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS基础/" itemprop="url" rel="index">
                    <span itemprop="name">iOS基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  接着上一章节，我们来利用runtime实现属性，思路利用runtime.h文件的2个函数完成操作，如下面所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line"> * Adds a property to a class.</div><div class="line"> * </div><div class="line"> * @param cls 修改的类</div><div class="line"> * @param name 属性名字</div><div class="line"> * @param attributes 属性数组</div><div class="line"> * @param attributeCount 属性数组数量</div><div class="line"> * @return y 成功,n失败</div><div class="line"> */</div><div class="line">OBJC_EXPORT BOOL class_addProperty(Class cls, const char *name, const objc_property_attribute_t *attributes, unsigned int attributeCount)</div><div class="line">    OBJC_AVAILABLE(10.7, 4.3, 9.0, 1.0);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/** </div><div class="line"> * Adds a new method to a class with a given name and implementation.</div><div class="line"> * </div><div class="line"> * @param cls The class to which to add a method.//添加方法名字</div><div class="line"> * @param name A selector that specifies the name of the method being added.//方法名称</div><div class="line"> * @param imp A function which is the implementation of the new method. The function must take at least two arguments—self and _cmd.//方法的实现必须至少2个参数,self 和 _cmd</div><div class="line"> * @param types An array of characters that describe the types of the arguments to the method. //描述</div><div class="line"> * </div><div class="line"> * @return YES if the method was added successfully, otherwise NO   //y成功,n失败</div><div class="line"> *  (for example, the class already contains a method implementation with that name).</div><div class="line"> *</div><div class="line"> * @note class_addMethod will add an override of a superclass&apos;s implementation, //会覆盖superclass 的实现;</div><div class="line"> *  but will not replace an existing implementation in this class. //已经存在的不会替换</div><div class="line"> *  To change an existing implementation, use method_setImplementation.//想要改变,使用method_setImplementation方法</div><div class="line"> */</div><div class="line">OBJC_EXPORT BOOL class_addMethod(Class cls, SEL name, IMP imp, </div><div class="line">                                 const char *types) </div><div class="line">    OBJC_AVAILABLE(10.5, 2.0, 9.0, 1.0);</div></pre></td></tr></table></figure>
<p>还是老话，talk is cheap, show me the code~<br>我们要生成一个name的属性;结果要跟@property 一样;</p>
<h3>1. 生成属性</h3>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">objc_property_attribute_t type = &#123; &quot;T&quot;, &quot;@\&quot;NSString\&quot;&quot; &#125;;</div><div class="line">objc_property_attribute_t ownership = &#123; &quot;C&quot;, &quot;&quot; &#125;; // C = copy</div><div class="line">objc_property_attribute_t nonatomic = &#123; &quot;N&quot;, &quot;&quot; &#125;; //nonatomic</div><div class="line">objc_property_attribute_t backingivar  = &#123; &quot;V&quot;, &quot;_name&quot; &#125;;//V 实例变量</div><div class="line">objc_property_attribute_t attrs[] = &#123; type, ownership,nonatomic, backingivar &#125;;</div><div class="line">class_addProperty([self class], &quot;name&quot;, attrs, 4);</div></pre></td></tr></table></figure>
<h3>2. 生成方法</h3>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">NSString *nameGetter(id self, SEL _cmd) &#123;</div><div class="line">    Ivar ivar = class_getInstanceVariable([self class], &quot;_privateName&quot;);</div><div class="line">    return object_getIvar(self, ivar);</div><div class="line">&#125;</div><div class="line">void myNameSetter(id self, SEL _cmd, NSString *newName) &#123;</div><div class="line">    Ivar ivar = class_getInstanceVariable([self class], &quot;_privateName&quot;);</div><div class="line">    id oldName = object_getIvar(self, ivar);</div><div class="line">    if (oldName != newName) object_setIvar(self, ivar, [newName copy]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//其中 “v@:” 表示返回值和参数</div><div class="line"></div><div class="line">if(class_addMethod([self class],  NSSelectorFromString(@&quot;name&quot;), (IMP)nameGetter, &quot;@@:&quot;))</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;name get 方法添加成功&quot;);</div><div class="line">&#125;</div><div class="line">else</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;name get 方法添加失败&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">if(class_addMethod([self class], NSSelectorFromString(@&quot;setName:&quot;), (IMP)nameSetter, &quot;v@:@&quot;))</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;name set 方法添加成功&quot;);</div><div class="line">&#125;</div><div class="line">else</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;name set 方法添加失败&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3>3. 打印结果</h3>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">方法列表:    (</div><div class="line">    &quot;setName:&quot;,</div><div class="line">    &quot;name&quot;,</div><div class="line">    &quot;touchesBegan:withEvent:&quot;,</div><div class="line">    &quot;viewDidLoad&quot;,</div><div class="line">    &quot;.cxx_destruct&quot;,</div><div class="line">    &quot;setName:&quot;,</div><div class="line">    &quot;name&quot;,</div></pre></td></tr></table></figure>
<h3>4. 扩展</h3>

<p>cxx_destruct 字面意思是自毁方法?</p>
<p>我们从第一篇代码结果显示会有这个，那这个到底是什么意思呢？<br>查找资料可以根据这篇博客:<a href="http://blog.jobbole.com/65028/" target="_blank" rel="external">http://blog.jobbole.com/65028/</a>来了解一下：<br>.cxx_destruct方法原本是为了C++对象析构的，ARC借用了这个方法插入代码实现了自动内存释放的工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1.只有在ARC下这个方法才会出现（试验代码的情况下）</div><div class="line">2.只有当前类拥有实例变量时（不论是不是用property）这个方法才会出现，且父类的实例变量不会导致子类拥有这个方法</div><div class="line">3.出现这个方法和变量是否被赋值，赋值成什么没有关系</div></pre></td></tr></table></figure>
<p>至此我们针对属性的本质有了深入的了解，争取以后每天都写博客针对OC、计算机原理，当然还有Python爬虫，最近由于时间紧工作忙碌，没有来得及写Python爬虫博客和做一些Demo，为此争取多挤出一些时间来写下，有了爬虫技术才能有数据，有数据就可以做分析了~</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/13/属性的本质/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/13/属性的本质/" itemprop="url">
                  属性的本质1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-13T17:40:40+08:00">
                2017-06-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS基础/" itemprop="url" rel="index">
                    <span itemprop="name">iOS基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p></p><h3>@property 的本质是什么？</h3><p></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property = ivar + getter + setter</div></pre></td></tr></table></figure>
<h4>1.验证</h4>

<p>talk is cheap, show me the code~</p>
<p>我们在类里面添加个属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#import &lt;UIKit/UIKit.h&gt;</div><div class="line"></div><div class="line">@interface ViewController : UIViewController</div><div class="line"></div><div class="line">@property (nonatomic, copy) NSString *name;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>在实现方法里代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">#import &quot;ViewController.h&quot;</div><div class="line">#import &lt;objc/runtime.h&gt;</div><div class="line"></div><div class="line">@interface ViewController ()</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];  </div><div class="line">    unsigned int count;</div><div class="line">    objc_property_t *propertyList = class_copyPropertyList([self class], &amp;count);</div><div class="line">    for (unsigned int i = 0; i&lt; count; i++)</div><div class="line">    &#123;</div><div class="line">        const char *name = property_getName(propertyList[i]);</div><div class="line">        NSLog(@&quot;__%@&quot;,[NSString stringWithUTF8String:name]);</div><div class="line">        objc_property_t property = propertyList[i];</div><div class="line">        const char *a = property_getAttributes(property);</div><div class="line">        NSLog(@&quot;属性信息__%@&quot;,[NSString stringWithUTF8String:a]);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)didReceiveMemoryWarning &#123;</div><div class="line">    [super didReceiveMemoryWarning];</div><div class="line">    // Dispose of any resources that can be recreated.</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>输出结果为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">__name</div><div class="line">属性信息__T@&quot;NSString&quot;,C,N,V_name</div></pre></td></tr></table></figure>
<p>再利用class_copyMethodList查看方法列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">u_int methodCount;</div><div class="line">NSMutableArray *methodList = [NSMutableArray array];</div><div class="line">Method *methods = class_copyMethodList([self class], &amp;methodCount);</div><div class="line">for (int i = 0; i &lt; methodCount; i++)</div><div class="line">&#123;</div><div class="line">    SEL name = method_getName(methods[i]);</div><div class="line">    NSString *strName = [NSString stringWithCString:sel_getName(name) encoding:NSUTF8StringEncoding];</div><div class="line">    [methodList addObject:strName];</div><div class="line">&#125;</div><div class="line">free(methods);</div><div class="line"></div><div class="line">NSLog(@&quot;方法列表:%@&quot;,methodList);</div></pre></td></tr></table></figure>
<p>结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">方法列表:    (</div><div class="line">    &quot;.cxx_destruct&quot;,</div><div class="line">    name,</div><div class="line">    didReceiveMemoryWarning,</div><div class="line">    viewDidLoad,</div><div class="line">    &quot;setName:&quot;,</div><div class="line">)</div></pre></td></tr></table></figure>
<p></p><h4>分析</h4><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">属性信息__T@&quot;NSString&quot;,C,N,V_name</div></pre></td></tr></table></figure><p></p>
<p>这一堆信息是什么?<br>翻阅Objective-C Runtime Programming Guide <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html" target="_blank" rel="external">https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtPropertyIntrospection.html</a> 找到线索，不难发现</p>
<p><img src="/2017/06/13/属性的本质/1.png" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//T@&quot;NSString&quot;,C,N,V_name</div><div class="line">//T 类型</div><div class="line">//C copy</div><div class="line">//N nonatomic</div><div class="line">//V 实例变量</div></pre></td></tr></table></figure>
<p>最终可以看出<strong>@property = ivar + getter + setter</strong><br>下篇讲解利用runtime实现的方法。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/12/自己动手构造编译系统：编译、汇编与链接笔记3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/12/自己动手构造编译系统：编译、汇编与链接笔记3/" itemprop="url">
                  自己动手构造编译系统：编译、汇编与链接笔记3
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-12T21:31:53+08:00">
                2017-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/计算机原理/" itemprop="url" rel="index">
                    <span itemprop="name">计算机原理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
               <h3>2.1  编译程序的设计</h3>

<p>   编译器是编译系统的核心，主要负责解析源程序的语义，生成目标机器代码。一般情况下，编译流程包含词法分析、语法分析、语义分析和代码生成四个阶段。符号表管理和错误处理贯穿于整个编译流程。如果编译器支持代码优化，那么还需要优化器模块。</p>
<p>   <img src="/2017/06/12/自己动手构造编译系统：编译、汇编与链接笔记3/1.png" alt="image"></p>
  <h3>2.1.1　词法分析</h3>

<p>  现在假定我们拥有一段使用C语言书写的源程序，词法分析器通过对源文件的扫描获得高级语言定义的词法记号。所谓词法记号（也称为终结符），反映在高级语言语法中就是对应的标识符、关键字、常量，以及运算符、逗号、分号等界符。</p>
<p>  对词法分析器的要求是能正常识别出这些不同形式的词法记号。词法分析器的输入是源代码文本文件内一长串的文本内容，那么如何从文本串中分析出每个词法记号呢？为了解决这个问题，需要引入有限自动机的概念。</p>
<p>  有限自动机能解析并识别词法记号，比如识别标识符的有限自动机、识别常量的有限自动机等。有限自动机从开始状态启动，读入一个字符作为输入，并根据该字符选择进入下一个状态。继续读入新的字符，直到遇到结束状态为止，读入的所有字符序列便是有限自动机识别的词法记号。</p>
<p>  使用有限自动机，可以识别出自定义语言包含的所有词法记号。把这些词法记号记录下来，作为下一步语法分析的输入。如果使用一遍编译方式，就不用记录这些词法记号，而是直接将识别的词法记号送入语法分析器进行处理。</p>
 <h3>2.1.2　语法分析</h3>

<p>  词法分析器的输入是文本字符串，语法分析器的输入则是词法分析器识别的词法记号序列。语法分析器的输出不再是一串线性符号序列，而是一种树形的数据结构，通常称之为抽象语法树。</p>
<p>  <img src="/2017/06/12/自己动手构造编译系统：编译、汇编与链接笔记3/2.png" alt="image"></p>
<p>  继续前面赋值语句的例子，我们可以先看看它可能对应的抽象语法树:</p>
<p>   <img src="/2017/06/12/自己动手构造编译系统：编译、汇编与链接笔记3/3.png" alt="image"></p>
<p>   所有的词法记号都出现在树的叶子节点上，我们称这样的叶子节点为终结符。而所有的非叶子节点，都是对一串词法记号的抽象概括，我们称之为非终结符，可以将非终结符看作一个单独的语法模块（抽象语法子树）。其实，整个源程序是一棵完整的抽象语法树，它由一系列语法模块按照树结构组织起来。语法分析器就是要获得源程序的抽象语法树表示，这样才能让编译器具体识别每个语法模块的含义，分析出程序的整体含义。</p>
<p>   在介绍语法分析器的工作之前，需要先获得高级语言语法的形式化表示，即文法。文法定义了源程序代码的书写规则，同时也是语法分析器构造抽象语法树的规则。如果要定义赋值语句的文法，一般可以表达成如下产生式的形式：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;赋值语句&gt;=&gt;标识符等号&lt;表达式&gt;分号</div></pre></td></tr></table></figure>
<p>   被“&lt;&gt;”括起来的内容表示非终结符，终结符直接书写即可，上式可以读作“赋值语句推导出标识符、等号、表达式和分号”。显然，表达式也有相关的文法定义。根据定义好的高级语言特性，可以设计出相应的高级语言的文法，使用文法可以准确地表达高级语言的语法规则。</p>
<p>   有了高级语言的文法表示，就可以构造语法分析器来生成抽象语法树。在编译原理教材中，描述了很多的文法分析算法，有自顶向下的LL（1）分析，也有自底向上的算符优先分析、LR分析等。其中最常使用的是LL（1）和LR分析。相比而言，LR分析器能力更强，但是分析器设计比较复杂，不适合手工构造。我们设计的高级语言文法，只要稍加约束便能使LL（1）分析器正常工作，因此本书采用LL（1）分析器来完成语法分析的工作。递归下降子程序作为LL（1）算法的一种便捷的实现方式，非常适合手工实现语法分析器。</p>
<p>   递归下降子程序的基本原则是：将产生式左侧的非终结符转化为函数定义，将产生式右侧的非终结符转化为函数调用，将终结符转化为词法记号匹配。例如前面提到的赋值语句对应的子程序的伪代码大致是这样的。</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">void 赋值语句()&#123;   </div><div class="line">match(标识符);    </div><div class="line">match(等号);</div><div class="line">表达式();</div><div class="line">match(分号);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>   每次对子程序的调用，就是按照前序的方式对该抽象语法子树的一次构造。例如在构造赋值语句子树时，会先构造“赋值语句”根节点，然后依次匹配标识符、等号子节点。当遇到下一个非终结符时，会进入对应的“表达式”子程序内继续按照前序方式构造子树的子树。最后匹配当前子程序的最后一个子节点，完成“赋值语句”子树的构造。整个语法分析就是按照这样的方式构造“程序”树的一个过程，一旦在终结符匹配过程中出现读入的词法记号与预期的词法记号不吻合的情况，便会产生语法错误。</p>
<p>   在实际语法分析器实现中，并不一定要显式地构造出抽象语法树。递归下降子程序实现的语法分析器，使得抽象语法树的语法模块都蕴含在每次子程序的执行中，即每次子程序的正确执行都表示识别了对应的语法模块。因此，可以在语法分析子程序中直接进行后续的工作，如语义分析及代码生成。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/12/使用NSProxy和NSObject设计代理类的差异/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/12/使用NSProxy和NSObject设计代理类的差异/" itemprop="url">
                  使用NSProxy和NSObject设计代理类的差异
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-12T10:47:06+08:00">
                2017-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS基础/" itemprop="url" rel="index">
                    <span itemprop="name">iOS基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>经常发现在一些需要使用消息转发而创建代理类时, 不同的程序员都有着不同的使用方法, 有些采用继承于NSObject, 而有一些采用继承自NSProxy。 二者都是Foundation框架中的基类, 并且都实现了<nsobject>这个接口, 从命名和文档中看NSProxy天生就是用来干这个事情的。 但即便如此, 它们却都定义了相同的消息转发的接口, 那我们在使用二者来完成这个工作时有什么差异呢。</nsobject></p>
<p>先贴一下通过二者来创建代理类的最基本实现代码。<br>继承自NSProxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@interface THProxyA : NSProxy</div><div class="line">@property (nonatomic, strong) id target;</div><div class="line">@end</div><div class="line">@implementation THProxyA</div><div class="line">- (id)initWithObject:(id)object &#123;</div><div class="line">    self.target = object;</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)selector &#123;</div><div class="line">    return [self.target methodSignatureForSelector:selector];</div><div class="line">&#125;</div><div class="line">- (void)forwardInvocation:(NSInvocation *)invocation &#123;</div><div class="line">    [invocation invokeWithTarget:self.target];</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>继承自NSObject</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">@interface THProxyB : NSObject</div><div class="line">@property (nonatomic, strong) id target;</div><div class="line">@end</div><div class="line">@implementation THProxyB</div><div class="line">- (id)initWithObject:(id)object &#123;</div><div class="line">    self = [super init];</div><div class="line">    if (self) &#123;</div><div class="line">        self.target = object;</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)selector &#123;</div><div class="line">    return [self.target methodSignatureForSelector:selector];</div><div class="line">&#125;</div><div class="line">- (void)forwardInvocation:(NSInvocation *)invocation &#123;</div><div class="line">    [invocation invokeWithTarget:self.target];</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>代码基本是一致的, 除了初始化时规范的写法有细节差异, 这个差异是因为NSProxy这个基类没有定义默认的init方法。</p>
<h4>1.经测试发现以下两个在<nsobject>中定义的接口, 在二者之间表现是不一致的:</nsobject></h4>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NSString *string = @&quot;test&quot;;</div><div class="line">THProxyA *proxyA = [[THProxyA alloc] initWithObject:string];</div><div class="line">THProxyB *proxyB = [[THProxyB alloc] initWithObject:string];</div><div class="line">NSLog(@&quot;%d&quot;, [proxyA respondsToSelector:@selector(length)]);</div><div class="line">NSLog(@&quot;%d&quot;, [proxyB respondsToSelector:@selector(length)]);</div><div class="line">NSLog(@&quot;%d&quot;, [proxyA isKindOfClass:[NSString class]]);</div><div class="line">NSLog(@&quot;%d&quot;, [proxyB isKindOfClass:[NSString class]]);</div></pre></td></tr></table></figure>
<p>结果会输出完成不同的结论:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1 0</div><div class="line">1 0</div></pre></td></tr></table></figure></p>
<p>也就是说通过继承自NSObject的代理类是不会自动转发respondsToSelector:和isKindOfClass:这两个方法的, 而继承自NSProxy的代理类却是可以的. 测试<nsobject>中定义的其它接口二者表现都是一致的。</nsobject></p>
<h4>2.NSObject的所有Category中定义的方法无法在THProxyB中完成转发</h4>

<p>举一个很常见的例子, valueForKey:是定义在NSKeyValueCoding这个NSObject的Category中的方法, 尝试二者执行的表现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NSLog(@&quot;%@&quot;,[proxyA valueForKey:@&quot;length&quot;]);</div><div class="line">NSLog(@&quot;%@&quot;,[proxyB valueForKey:@&quot;length&quot;]);</div></pre></td></tr></table></figure>
<p>这段代码第一句能正确运行, 但第二行却会抛出异常, 分析最终原因其实很简单, 因为valueForKey:是NSObject的Category中定义的方法, 让NSObject具备了这样的接口, 而消息转发是只有当接收者无法处理时才会通过forwardInvocation:来寻求能够处理的对象。</p>
<h4>3.结论: 如此看来NSProxy确实更适合实现做为消息转发的代理类, 因为作为一个抽象类, NSProxy自身能够处理的方法极小(仅<nsobject>接口中定义的部分方法), 所以其它方法都能够按照设计的预期被转发到被代理的对象中。</nsobject></h4>




          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/11/信号量dispatch-semaphore的理解及实际运用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/11/信号量dispatch-semaphore的理解及实际运用/" itemprop="url">
                  信号量dispatch_semaphore的理解及实际运用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-11T18:46:06+08:00">
                2017-06-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS基础/" itemprop="url" rel="index">
                    <span itemprop="name">iOS基础</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  信号量：就是一种可用来控制访问资源的数量的标识，设定了一个信号量，在线程访问之前，加上信号量的处理，则可告知系统按照我们指定的信号量数量来执行多个线程。</p>
<p>  其实，这有点类似锁机制了，只不过信号量都是系统帮助我们处理了，我们只需要在执行线程之前，设定一个信号量值，并且在使用时，加上信号量处理方法就行了。</p>
<p>  信号量为0则阻塞线程，大于0则不会阻塞。因此我们可以通过改变信号量的值，来控制是否阻塞线程，从而达到线程同步。</p>
<p>在GCD中有三个函数是semaphore的操作，分别是：<br>dispatch_semaphore_create　　　创建一个semaphore<br>dispatch_semaphore_signal　　　发送一个信号<br>dispatch_semaphore_wait　　　　等待信号<br>　　<br>  简单的介绍一下这三个函数，第一个函数有一个整形的参数，我们可以理解为信号的总量，dispatch_semaphore_signal是发送一个信号，自然会让信号总量加1，dispatch_semaphore_wait等待信号，当信号总量少于0的时候就会一直等待，否则就可以正常的执行，并让信号总量-1，根据这样的原理，我们便可以快速的创建一个并发控制来同步任务和有限资源访问控制。<br>　　<br>实际开发中，我们通常会遇到如下问题：</p>
<h3>一、某界面存在多个请求，希望所有请求均结束才进行某操作。</h3><br>对于这一问题的解决方案很容易想到通过线程组进行实现，代码如下：<br><br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">dispatch_group_t group = dispatch_group_create();</div><div class="line">dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">    //请求1</div><div class="line">    [self request_A];</div><div class="line">&#125;);</div><div class="line">dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">    //请求2</div><div class="line">    [self request_B];</div><div class="line">&#125;);</div><div class="line">dispatch_group_async(group, dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</div><div class="line">    //请求3</div><div class="line">     [self request_C];</div><div class="line">&#125;);</div><div class="line">dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</div><div class="line">    //界面刷新</div><div class="line">    NSLog(@&quot;任务均完成，刷新界面&quot;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure><br><br>  这里我们书写一个网络请求通用方法，假设同时请求某新闻列表的3页数据，每页均为一个独立的网络请求。使用我们最常用的AFNet请求，方法如下（真实开发中可能为banner数据请求、主体网络请求、广告网络请求等）：<br><br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (void)request_A &#123;</div><div class="line"> AFHTTPSessionManager *manager = [AFHTTPSessionManager manager];;</div><div class="line"> manager.responseSerializer = [AFHTTPResponseSerializer serializer];</div><div class="line"> NSDictionary *parameter = @&#123;@&quot;token&quot;:@&quot;63104AB32427EBF89B957BBD1A5C5C11&quot;,</div><div class="line">                              @&quot;page&quot;:@&quot;1&quot;,</div><div class="line">                              @&quot;upTime&quot;:@&quot;desc&quot;&#125;;</div><div class="line">	</div><div class="line"> [manager POST:URL parameters:parameter progress:^(NSProgress * _Nonnull uploadProgress) &#123;</div><div class="line">	</div><div class="line"> &#125; success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) &#123;</div><div class="line">	</div><div class="line">     NSDictionary * dict = [NSJSONSerialization JSONObjectWithData:responseObject options:NSJSONReadingMutableContainers error:nil];</div><div class="line">     for (NSDictionary *rowsDict in dict[@&quot;rows&quot;]) &#123;</div><div class="line">         NSLog(@&quot;A___%@&quot;,rowsDict[@&quot;title&quot;]);</div><div class="line">     &#125;</div><div class="line"> &#125; failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) &#123;</div><div class="line">	</div><div class="line"> &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>  request_B、request_C分别为请求第二页与第三页数据，这里不重复书写。为了显示更加明显，在请求中打印了对应新闻的标题内容。<br><br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">  任务均完成，刷新界面</div><div class="line">C___搞笑，不是认真的</div><div class="line">C___摄影 | 街拍</div><div class="line">C___生活小窍门</div><div class="line">C___传统中国</div><div class="line">C___想吃的美食系列</div><div class="line">B___时间的见证者</div><div class="line">B___没事 来吐槽吧……</div><div class="line">B___触动心灵的摄影</div><div class="line">B___摄影 | 黑白印记</div><div class="line">B___每日插画推荐</div><div class="line">A___左爱情，右面包</div><div class="line">A___潮我看</div><div class="line">A___世界各国的人们怎么过情人节</div><div class="line">A___一点创意点亮生活</div><div class="line">A___摄影 | 随手拍</div></pre></td></tr></table></figure><br><br><br>   运行后马上接收到了线程组完成的提示，之后数据才依次请求下来，很明显三个单纯的AFNet请求已经不能满足我们的需求了。线程组完成时并没有在我们希望的时候给予通知。在真实开发中会造成的问题为多个请求均加载完成，但界面已在未得到数据前提前刷新导致界面空白。<br><br>   因此对于这种问题需要另辟蹊径，这里我们就要借助GCD中的信号量dispatch_semaphore进行实现，即营造线程同步情况。<br>dispatch_semaphore信号量为基于计数器的一种多线程同步机制。用于解决在多个线程访问共有资源时候，会因为多线程的特性而引发数据出错的问题。<br><br>  如果semaphore计数大于等于1，计数-1，返回，程序继续运行。如果计数为0，则等待。<br><br>   dispatch_semaphore_signal(semaphore)为计数+1操作。dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER)为设置等待时间，这里设置的等待时间是一直等待。<br><br>我们将网络请求通用方法进行修改如下：<br><br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (void)request_A &#123;</div><div class="line">  //创建信号量并设置计数默认为0</div><div class="line">  dispatch_semaphore_t sema = dispatch_semaphore_create(0);</div><div class="line"></div><div class="line">  AFHTTPSessionManager *manager = [AFHTTPSessionManager manager];;</div><div class="line">  manager.responseSerializer = [AFHTTPResponseSerializer serializer];</div><div class="line">  NSDictionary *parameter = @&#123;@&quot;token&quot;:@&quot;63104AB32427EBF89B957BBD1A5C5C11&quot;,</div><div class="line">                               @&quot;page&quot;:@&quot;1&quot;,</div><div class="line">                               @&quot;upTime&quot;:@&quot;desc&quot;&#125;;</div><div class="line"></div><div class="line">  [manager POST:URL parameters:parameter progress:^(NSProgress * _Nonnull uploadProgress) &#123;</div><div class="line"></div><div class="line">  &#125; success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) &#123;</div><div class="line">      //计数+1操作</div><div class="line">      dispatch_semaphore_signal(sema);</div><div class="line">      NSDictionary * dict = [NSJSONSerialization JSONObjectWithData:responseObject options:NSJSONReadingMutableContainers error:nil];</div><div class="line">      for (NSDictionary *rowsDict in dict[@&quot;rows&quot;]) &#123;</div><div class="line">          NSLog(@&quot;A___%@&quot;,rowsDict[@&quot;title&quot;]);</div><div class="line">      &#125;</div><div class="line">  &#125; failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) &#123;</div><div class="line">      ////计数+1操作</div><div class="line">      dispatch_semaphore_signal(sema);</div><div class="line">  &#125;];</div><div class="line">  //若计数为0则一直等待</div><div class="line">  dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>   为方便阅读，伪代码如下：<br><br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">  dispatch_semaphore_t sema = dispatch_semaphore_create(0);</div><div class="line">[网络请求:&#123;</div><div class="line">    成功：dispatch_semaphore_signal(sema);</div><div class="line">    失败：dispatch_semaphore_signal(sema);</div><div class="line">&#125;];</div><div class="line">dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER);</div></pre></td></tr></table></figure><br><br>   这时我们再运行程序，打印如下：<br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">C___聆听的耳朵</div><div class="line">C___家居 | 你的家里还缺点什么？</div><div class="line">C___logo设计</div><div class="line">C___时装</div><div class="line">C___搞笑，不是认真的</div><div class="line">A___左爱情，右面包</div><div class="line">A___潮我看</div><div class="line">A___世界各国的人们怎么过情人节</div><div class="line">A___一点创意点亮生活</div><div class="line">A___摄影 | 随手拍</div><div class="line">B___时间的见证者</div><div class="line">B___没事 来吐槽吧……</div><div class="line">B___触动心灵的摄影</div><div class="line">B___摄影 | 黑白印记</div><div class="line">B___每日插画推荐</div><div class="line">任务均完成，刷新界面</div></pre></td></tr></table></figure><br><br>   运行打印可见，通过信号量dispatch_semaphore完美的解决了此问题，并且网络请求仍为异步，不会堵塞当前主线程。<br><br>   <h3>二、某界面存在多个请求，希望请求依次执行。</h3>

<p>   对于这个问题通常会通过线程依赖进行解决，因使用GCD设置线程依赖比较繁琐，这里通过NSOperationQueue进行实现，这里采用比较经典的例子，三个任务分别为下载图片，打水印和上传图片，三个任务需异步执行但需要顺序性。代码如下，下载图片、打水印、上传图片仍模拟为分别请求新闻列表3页数据。</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">//1.任务一：下载图片</div><div class="line"> NSBlockOperation *operation1 = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">     [self request_A];</div><div class="line"> &#125;];</div><div class="line"></div><div class="line"> //2.任务二：打水印</div><div class="line"> NSBlockOperation *operation2 = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">     [self request_B];</div><div class="line"> &#125;];</div><div class="line"></div><div class="line"> //3.任务三：上传图片</div><div class="line"> NSBlockOperation *operation3 = [NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">     [self request_C];</div><div class="line"> &#125;];</div><div class="line"></div><div class="line"> //4.设置依赖</div><div class="line"> [operation2 addDependency:operation1];      //任务二依赖任务一</div><div class="line"> [operation3 addDependency:operation2];      //任务三依赖任务二</div><div class="line"></div><div class="line"> //5.创建队列并加入任务</div><div class="line"> NSOperationQueue *queue = [[NSOperationQueue alloc] init];</div><div class="line"> [queue addOperations:@[operation3, operation2, operation1] waitUntilFinished:NO];</div></pre></td></tr></table></figure>
<p>   首先我们使用未添加信号量dispatch_semaphore时运行，打印如下:</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">   B___时间的见证者</div><div class="line">B___没事 来吐槽吧……</div><div class="line">B___触动心灵的摄影</div><div class="line">B___摄影 | 黑白印记</div><div class="line">B___每日插画推荐</div><div class="line">A___潮我看</div><div class="line">A___左爱情，右面包</div><div class="line">A___世界各国的人们怎么过情人节</div><div class="line">A___一点创意点亮生活</div><div class="line">A___摄影 | 随手拍</div><div class="line">C___盘</div><div class="line">C___聆听的耳朵</div><div class="line">C___家居 | 你的家里还缺点什么？</div><div class="line">C___logo设计</div><div class="line">C___时装</div></pre></td></tr></table></figure>
<p>   根据打印结果可见，若不对请求方法做处理，其运行结果并不是我们想要的，联系实际需求，A、B、C请求分别对应下载图片、打水印、上传图片，而此时运行顺序则为B-&gt;A-&gt;C，在未获得图片时即执行打水印操作明显是错误的。重复运行亦会出现不同结果，即请求不做处理，其结果不可控无法预测。线程依赖设置并未起到作用。</p>
<p>解决此问题的方法仍可通过信号量dispatch_semaphore进行解决。我们将请求方法替换为添加dispatch_semaphore限制的形式。即</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">  dispatch_semaphore_t sema = dispatch_semaphore_create(0);</div><div class="line">[网络请求:&#123;</div><div class="line">        成功：dispatch_semaphore_signal(sema);</div><div class="line">        失败：dispatch_semaphore_signal(sema);</div><div class="line">&#125;]</div><div class="line">dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER);</div></pre></td></tr></table></figure>
<p>  再次重复运行，我们会发现每次运行结果均一致，A、B、C三任务异步顺序执行（A-&gt;B-&gt;C）</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">   A___潮我看</div><div class="line">A___左爱情，右面包</div><div class="line">A___世界各国的人们怎么过情人节</div><div class="line">A___一点创意点亮生活</div><div class="line">A___摄影 | 随手拍</div><div class="line">B___时间的见证者</div><div class="line">B___没事 来吐槽吧……</div><div class="line">B___触动心灵的摄影</div><div class="line">B___摄影 | 黑白印记</div><div class="line">B___每日插画推荐</div><div class="line">C___盘</div><div class="line">C___聆听的耳朵</div><div class="line">C___家居 | 你的家里还缺点什么？</div><div class="line">C___logo设计</div><div class="line">C___时装</div></pre></td></tr></table></figure>
<p>   通过重复运行打印结果可证实确实实现了我们想要的效果。这样即解决了所提出的问题二。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/07/自己动手构造编译系统：编译、汇编与链接笔记2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Bill">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/images/avatar/avatar/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="李超的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/07/自己动手构造编译系统：编译、汇编与链接笔记2/" itemprop="url">
                  自己动手构造编译系统：编译、汇编与链接笔记2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-07T17:54:43+08:00">
                2017-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/计算机原理/" itemprop="url" rel="index">
                    <span itemprop="name">计算机原理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>  本次笔记比上次更有难度，因为涉及到汇编的只是，由于汇编涉及的比较底层，而且自己对于汇编有很多还不了解，所以在写完此次课程开始恶补汇编知识，以此来深入理解本书的内容，而且后期的汇编器也深入讨论汇编知识，所以就此通过这次机会学习一下汇编来补习知识。</p>
<p>  我们写一个最简单的“HelloWorld”程序，代码存储在源文件hello.c中，源文件内容如下：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">int main()</div><div class="line">&#123;    </div><div class="line"> printf(&quot;Hello World!&quot;);   </div><div class="line"> return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 如果将hello.c编译并静态链接为可执行文件，查看GCC背后的工作流程，可以使用–verbose选项如下(主意针对Mac 命令会有所不同 查看)：<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$gcc hello.c –o hello -S --verbose</div></pre></td></tr></table></figure></p>
<p>  通过文件夹目录可以看出多出两个文件 main.s汇编文件和main可执行文件。可以看出，GCC编译背后使用了cc1、as、collect2三个命令。其中cc1是GCC的编译器，它将源文件hello.c编译为hello.s。as是汇编器命令，它将hello.s汇编为hello.o目标文件。collect2是链接器命令，它是对命令ld的封装。静态链接时，GCC将C语言运行时库（CRT）内的5个重要的目标文件crt1.o、crti.o、crtbe-ginT.o、crtend.o、crtn.o以及3个静态库libgcc.a、libgcc_eh.a、libc.a链接到可执行文件hello。此外，cc1在对源文件编译之前，还有预编译的过程。</p>
<h4>1.预编译</h4>

<p>  GCC对源文件的第一阶段的处理是预编译，主要是处理宏定义和文件包含等信息。命令格式如下：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -E main.c -o main.i</div></pre></td></tr></table></figure>
<p>  预编译器将hello.c处理后输出到文件hello.i。比如文件包含语句#include<stdio.h>，预编译器会将stdio.h的文件内容拷贝到#include语句声明的位置。如果源文件内使用#define语句定义了宏，预编译器则将该宏的内容替换到其被引用的位置。如果宏定义本身使用了其他宏，则预编译器需要将宏递归地展开。</stdio.h></p>
<p>  我们可以将预编译的工作简单地理解为源码的文本替换，即将宏定义的内容替换到宏的引用位置。当然，这样理解有一定的片面性，因为要考虑宏定义中使用其他宏的情况。事实上预编译器的实现机制和编译器有着很大的相似性，因此本书描述的编译系统将重点放在源代码的编译上，不再独立实现预编译器。然而，我们需要清楚的事实是：一个完善的编译器是需要预编译器的。</p>
<h4>2.编译</h4>

<p>  接下来GCC对hello.i进行编译，命令如下：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$gcc –S hello.i –o</div></pre></td></tr></table></figure>
<p>  hello.s编译后产生的汇编文件hello.s</p>
<h4>3.汇编</h4>

<p>  接着，GCC使用汇编器对hello.s进行汇编，命令如下：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$gcc –c hello.s –o hello.o</div></pre></td></tr></table></figure>
<p>  生成的目标文件hello.o，Linux下称之为可重定位目标文件。目标文件无法使用文本编辑器直接查看，但是我们可以使用GCC自带的工具objdump命令分析它的内容，命令格式如下：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$objdump –sd hello.o</div></pre></td></tr></table></figure>
<p>  从数据段二进制信息的ASCII形式的显示中，我们看到了汇编语言内定义的字符串数据“Hello World！”。代码段的信息和汇编文件代码信息基本吻合，但是我们发现了很多不同之处。比如汇编文件内的指令“movl$.LC0，%eax”中的符号.LC0的地址（字符串“Hello World！”的地址）被换成了0。指令“callprintf”内符号printf的相对地址被换成了0xfffffffc，即call指令操作数部分的起始地址。这些区别本质来源于汇编语言符号的引用问题。由于汇编器在处理当前文件的过程中无法获悉符号的虚拟地址，因此临时将这些符号地址设置为默认值0，真正的符号地址只有在链接的时候才能确定。</p>
<h4>4.链接</h4>

<p>使用GCC命令进行目标文件链接很简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc hello.o –o hello</div></pre></td></tr></table></figure>
<p>GCC默认使用动态链接，如果要进行静态链接，需加上-static选项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc hello.o –o hello –static</div></pre></td></tr></table></figure>
<p>这样生成的可执行文件hello便能正常执行了。我们使用objdump命令查看一下静态链接后的可执行文件内的信息。由于可执行文件中包含了大量的C语言库文件，因此这里不便将文件的所有信息展示出来，仅显示最终main函数的可执行代码。</p>
<p>从main函数的可执行代码中，我们发现汇编过程中描述的无法确定的符号地址信息在这里都被修正为实际的符号地址。如“Hello World！”字符串的地址为0x080ae828，printf函数的地址为0x08048dd0。这里符号_IO_printf与printf完全等价，call指令内部相对地址为0x000afa，正好是printf地址相对于call指令下条指令起始地址0x080482d6的偏移。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/images/avatar/avatar/avatar.jpg"
               alt="Bill" />
          <p class="site-author-name" itemprop="name">Bill</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bill</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">访客数<span class="busuanzi-value" id="busuanzi_value_site_uv"></span>人次</span>
  

  
    <span class="site-pv">总访问量<span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span>
  
  
</div>



        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


  

</body>
</html>
